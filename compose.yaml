services:
  nats-bridge:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    volumes:
      - .:/app
      - ./example-config.json:/app/example-config.json:ro
    environment:
      - CONFIG_PATH=/app/example-config.json
      - NATS_URL=nats://nats:4222
      - HEALTH_PORT=8080
      - ENV=dev
    depends_on:
      nats-setup:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "grpc_health_probe", "-addr=:8080"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 1m

  nats-setup:
    image: natsio/nats-box:latest
    depends_on:
      nats:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        nats stream add EXAMPLE_EVENTS \
          --server=nats://nats:4222 \
          --subjects="example.>" \
          --defaults
        echo "Stream EXAMPLE_EVENTS created successfully"

  nats:
    image: nats:alpine
    command: ["--jetstream", "--http_port", "8222"]
    ports:
      - "4222:4222"
      - "8222:8222"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8222/healthz"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s
